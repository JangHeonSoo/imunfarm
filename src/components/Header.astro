---
import HeaderLink from '@/components/HeaderLink'
import TwitterIcon from '@/components/icons/TwitterIcon'
import GithubIcon from '@/components/icons/GithubIcon'
import MenuIcon from './icons/MenuIcon.astro'
import Search from '@/components/Search'
import TagIcon from './icons/TagIcon.astro'
import ToggleTheme from './ToggleTheme.astro'
import { siteConfig } from '@/data/site.config'

// ADD YOUR SOCIAL NETWORKS HERE
const SOCIALNETWORKS = [
	{
		name: 'Github',
		url: `https://github.com/${siteConfig.social.github}`,
		icon: GithubIcon
	},

	{
		name: 'Twitter',
		url: `https://twitter.com/${siteConfig.social.twitter}`,
		icon: TwitterIcon
	}
].filter(network => siteConfig.social.github || siteConfig.social.twitter)
---

<header class='fixed top-0 left-0 right-0 w-full h-20 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md z-50 border-b border-black/5 dark:border-white/10'>
	<div class='w-full h-full px-5 md:px-8 lg:px-12 flex justify-between items-center'>
		<a class='text-2xl font-heading font-bold text-primary-dark dark:text-primary tracking-tight' href='/'>
			IMUN<span class='text-secondary'>.FARM</span>
		</a>

		<nav class='hidden md:flex items-center gap-8'>
			<HeaderLink href='/' class='text-text-main dark:text-gray-300 font-medium hover:text-primary dark:hover:text-primary transition-colors'>
				홈
			</HeaderLink>
			<HeaderLink href='/about' class='text-text-main dark:text-gray-300 font-medium hover:text-primary dark:hover:text-primary transition-colors'>
				About
			</HeaderLink>
			<HeaderLink href='/contact' class='text-text-main dark:text-gray-300 font-medium hover:text-primary dark:hover:text-primary transition-colors'>
				협찬문의
			</HeaderLink>
			<HeaderLink href='/tags' class='text-text-main dark:text-gray-300 font-medium hover:text-primary dark:hover:text-primary transition-colors'>
				Tags
			</HeaderLink>
			
			<div class='flex items-center gap-3'>
				<!-- Language Toggle -->
				<div id="lang-toggle" class="flex items-center bg-gray-100 dark:bg-gray-800 rounded-full p-0.5 text-xs font-bold cursor-pointer select-none border border-gray-200 dark:border-gray-700">
					<button id="lang-ko" class="px-2.5 py-1 rounded-full transition-all duration-200">KO</button>
					<button id="lang-en" class="px-2.5 py-1 rounded-full transition-all duration-200">EN</button>
				</div>
				<Search />
				<ToggleTheme />
			</div>
		</nav>

		<button id='astro-header-drawer-button' type='button' class='md:hidden'>
			<MenuIcon />
			<span class='sr-only'>Show Menu</span>
		</button>
	</div>
</header>

<!-- Mobile Menu -->
<div
	id='astro-header-drawer'
	class='md:hidden fixed top-20 right-0 w-64 h-screen bg-white dark:bg-gray-800 shadow-xl transform translate-x-full transition-transform duration-300 z-40'
>
	<nav class='flex flex-col p-6 gap-4'>
		<HeaderLink href='/' class='text-lg'>홈</HeaderLink>
		<HeaderLink href='/about' class='text-lg'>About</HeaderLink>
		<HeaderLink href='/contact' class='text-lg'>협찬문의</HeaderLink>
		<HeaderLink href='/tags' class='text-lg'>Tags</HeaderLink>
		<!-- Mobile Language Toggle -->
		<div class="flex items-center gap-2 mt-2">
			<span class="text-sm text-gray-500 dark:text-gray-400">Language:</span>
			<div id="lang-toggle-mobile" class="flex items-center bg-gray-100 dark:bg-gray-700 rounded-full p-0.5 text-xs font-bold cursor-pointer select-none border border-gray-200 dark:border-gray-600">
				<button id="lang-ko-mobile" class="px-2.5 py-1 rounded-full transition-all duration-200">KO</button>
				<button id="lang-en-mobile" class="px-2.5 py-1 rounded-full transition-all duration-200">EN</button>
			</div>
		</div>
	</nav>
</div>

<script>
	function initMobileMenu() {
		const menu = document.getElementById('astro-header-drawer')
		const menuButton = document.getElementById('astro-header-drawer-button')
		
		if (!menu || !menuButton) return
		
		menuButton.addEventListener('click', (e) => {
			e.stopPropagation()
			menu.classList.toggle('translate-x-full')
		})
		
		document.addEventListener('click', (event) => {
			const isClickInside = menu.contains(event.target as HTMLElement) || 
			                      menuButton.contains(event.target as HTMLElement)
			if (!isClickInside && !menu.classList.contains('translate-x-full')) {
				menu.classList.add('translate-x-full')
			}
		})
		
		const menuLinks = menu.querySelectorAll('a')
		menuLinks.forEach(link => {
			link.addEventListener('click', () => {
				menu.classList.add('translate-x-full')
			})
		})
	}

	function initLangToggle() {
		const lang = localStorage.getItem('site-lang') || 'ko'
		updateLangUI(lang)

		// Desktop buttons
		document.getElementById('lang-ko')?.addEventListener('click', () => setLang('ko'))
		document.getElementById('lang-en')?.addEventListener('click', () => setLang('en'))
		// Mobile buttons
		document.getElementById('lang-ko-mobile')?.addEventListener('click', () => setLang('ko'))
		document.getElementById('lang-en-mobile')?.addEventListener('click', () => setLang('en'))
	}

	function setLang(lang: string) {
		localStorage.setItem('site-lang', lang)
		updateLangUI(lang)
		document.dispatchEvent(new CustomEvent('langchange', { detail: { lang } }))
	}

	function updateLangUI(lang: string) {
		const activeClass = 'bg-primary text-white shadow-sm'
		const inactiveClass = 'text-gray-500 dark:text-gray-400'

		const ids = [
			{ ko: 'lang-ko', en: 'lang-en' },
			{ ko: 'lang-ko-mobile', en: 'lang-en-mobile' }
		]

		ids.forEach(({ ko, en }) => {
			const koBtn = document.getElementById(ko)
			const enBtn = document.getElementById(en)
			if (!koBtn || !enBtn) return

			// Reset
			koBtn.className = `px-2.5 py-1 rounded-full transition-all duration-200 ${lang === 'ko' ? activeClass : inactiveClass}`
			enBtn.className = `px-2.5 py-1 rounded-full transition-all duration-200 ${lang === 'en' ? activeClass : inactiveClass}`
		})
	}
	
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', () => { initMobileMenu(); initLangToggle(); })
	} else {
		initMobileMenu()
		initLangToggle()
	}
	
	document.addEventListener('astro:page-load', () => { initMobileMenu(); initLangToggle(); })
</script>
