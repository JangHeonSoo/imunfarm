---
import HeaderLink from '@/components/HeaderLink'
import TwitterIcon from '@/components/icons/TwitterIcon'
import GithubIcon from '@/components/icons/GithubIcon'
import MenuIcon from './icons/MenuIcon.astro'
import Search from '@/components/Search'
import TagIcon from './icons/TagIcon.astro'
import ToggleTheme from './ToggleTheme.astro'
import { siteConfig } from '@/data/site.config'
import { CATEGORIES } from '@/data/categories'
import { DEFAULT_LOCALE, SUPPORTED_LOCALES, getLocalePrefix, getPostUrl } from '@/utils'

const { postSlug, postCategory } = Astro.props

const SOCIALNETWORKS = [
	{
		name: 'Github',
		url: `https://github.com/${siteConfig.social.github}`,
		icon: GithubIcon
	},

	{
		name: 'Twitter',
		url: `https://twitter.com/${siteConfig.social.twitter}`,
		icon: TwitterIcon
	}
].filter(network => siteConfig.social.github || siteConfig.social.twitter)

const currentLocale = Astro.currentLocale ?? DEFAULT_LOCALE
const localePrefix = getLocalePrefix(currentLocale)
const currentPath = Astro.url.pathname

const buildLocalePath = (targetLocale: string) => {
	// If we have explicit post info, use getPostUrl for precise mapping
	if (postSlug) {
		return getPostUrl(postSlug, targetLocale, postCategory)
	}

	const segments = currentPath.split('/').filter(Boolean)
	const hasLocalePrefix = SUPPORTED_LOCALES.includes(segments[0] as any)
	const rest = hasLocalePrefix ? segments.slice(1) : segments

	// Prevent /ko prefix if not wanted, but keep others
	const effectivePrefix = targetLocale === DEFAULT_LOCALE ? '' : `/${targetLocale}`

	// Handle Tags mapping
	if (rest[0] === 'tags') {
		return `${effectivePrefix}/${rest.join('/')}`
	}

	const newPath = `/${[targetLocale, ...rest].join('/')}`
	return newPath.replace(/\/ko\//, '/').replace(/\/ko$/, '/')
}
const buildHomePath = (targetLocale: string) => {
	return targetLocale === DEFAULT_LOCALE ? '/' : `/${targetLocale}/`
}
---

<header class='fixed top-0 left-0 right-0 w-full h-20 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md z-50 border-b border-black/5 dark:border-white/10'>
	<div class='w-full h-full px-5 md:px-8 lg:px-12 flex justify-between items-center'>
		<a class='text-2xl font-heading font-bold text-primary-dark dark:text-primary tracking-tight' href={buildHomePath(currentLocale)}>
			IMUN<span class='text-secondary'>.FARM</span>
		</a>

		<nav class='hidden md:flex items-center gap-8'>
			<HeaderLink href={`${localePrefix}/`} class='text-text-main dark:text-gray-300 font-medium hover:text-primary dark:hover:text-primary transition-colors'>
				{currentLocale === 'en' ? 'Home' : '홈'}
			</HeaderLink>
			<HeaderLink href={`${localePrefix}/about`} class='text-text-main dark:text-gray-300 font-medium hover:text-primary dark:hover:text-primary transition-colors'>
				About
			</HeaderLink>
			<HeaderLink href={`${localePrefix}/contact`} class='text-text-main dark:text-gray-300 font-medium hover:text-primary dark:hover:text-primary transition-colors'>
				{currentLocale === 'en' ? 'Contact' : '협찬문의'}
			</HeaderLink>
			<HeaderLink href={`${localePrefix}/tags`} class='text-text-main dark:text-gray-300 font-medium hover:text-primary dark:hover:text-primary transition-colors'>
				Tags
			</HeaderLink>
			
			<div class='flex items-center gap-3'>
				<!-- Language Toggle (URL-based) -->
				<div class='flex items-center gap-2 text-xs font-bold uppercase tracking-wider'>
					{SUPPORTED_LOCALES.map((locale: (typeof SUPPORTED_LOCALES)[number]) => (
						<a
							href={buildLocalePath(locale)}
							class={
								locale === currentLocale
									? 'text-primary'
									: 'text-gray-500 hover:text-primary'
							}
						>
							{locale.toUpperCase()}
						</a>
					))}
				</div>
				<Search />
				<ToggleTheme />
			</div>
		</nav>

		<button id='astro-header-drawer-button' type='button' class='md:hidden'>
			<MenuIcon />
			<span class='sr-only'>Show Menu</span>
		</button>
	</div>
</header>

<!-- Mobile Menu -->
<div
	id='astro-header-drawer'
	class='md:hidden fixed top-20 right-0 w-64 h-screen bg-white dark:bg-gray-800 shadow-xl transform translate-x-full transition-transform duration-300 z-40'
>
	<nav class='flex flex-col p-6 gap-4'>
		<HeaderLink href={`${localePrefix}/`} class='text-lg'>{currentLocale === 'en' ? 'Home' : '홈'}</HeaderLink>
		<HeaderLink href={`${localePrefix}/about`} class='text-lg'>About</HeaderLink>
		<HeaderLink href={`${localePrefix}/contact`} class='text-lg'>{currentLocale === 'en' ? 'Contact' : '협찬문의'}</HeaderLink>
		<HeaderLink href={`${localePrefix}/tags`} class='text-lg'>Tags</HeaderLink>
		<!-- Mobile Language Toggle -->
		<div class="flex items-center gap-2 mt-2">
			<span class="text-sm text-gray-500 dark:text-gray-400">Language:</span>
			<div class="flex items-center gap-3 text-sm font-bold uppercase">
				{SUPPORTED_LOCALES.map((locale: (typeof SUPPORTED_LOCALES)[number]) => (
					<a
						href={buildLocalePath(locale)}
						class={
							locale === currentLocale
								? 'text-primary'
								: 'text-gray-500 hover:text-primary'
						}
					>
						{locale.toUpperCase()}
					</a>
				))}
			</div>
		</div>
	</nav>
</div>

<script>
	function initMobileMenu() {
		const menu = document.getElementById('astro-header-drawer')
		const menuButton = document.getElementById('astro-header-drawer-button')
		
		if (!menu || !menuButton) return
		
		menuButton.addEventListener('click', (e) => {
			e.stopPropagation()
			menu.classList.toggle('translate-x-full')
		})
		
		document.addEventListener('click', (event) => {
			const isClickInside = menu.contains(event.target as HTMLElement) || 
			                      menuButton.contains(event.target as HTMLElement)
			if (!isClickInside && !menu.classList.contains('translate-x-full')) {
				menu.classList.add('translate-x-full')
			}
		})
		
		const menuLinks = menu.querySelectorAll('a')
		menuLinks.forEach(link => {
			link.addEventListener('click', () => {
				menu.classList.add('translate-x-full')
			})
		})
	}
	
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initMobileMenu)
	} else {
		initMobileMenu()
	}
	
	document.addEventListener('astro:page-load', initMobileMenu)
</script>
