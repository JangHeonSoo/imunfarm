---
import BaseLayout from '@/layouts/BaseLayout'
import ListPosts from '@/components/ListPosts'
import ListCategories from '@/components/ListCategories'
import TitlePage from '@/components/TitlePage'
import {
	getCategories,
	getCategorySlug,
	getCategoryTitleFromSlug,
	getIndexPageByCategory,
	getPosts,
    DEFAULT_LOCALE,
    SUPPORTED_LOCALES
} from '@/utils'
import { siteConfig } from '@/data/site.config'
import Pagination from '@/components/Pagination'
import Code from '@/components/mdx/Code'
import SButton from '@/components/mdx/SButton'
import { components } from '../../../components/mixins/AutoImportComponents'

export async function getStaticPaths({ paginate }: any) {
	const categoriesSet = new Set<string>()
	await Promise.all(
		SUPPORTED_LOCALES.map(async (locale) => {
			const cats = await getCategories(locale)
			cats.forEach((c) => categoriesSet.add(c))
		})
	)
	const categories = Array.from(categoriesSet)
    
    return (await Promise.all(
        SUPPORTED_LOCALES.filter(l => l !== DEFAULT_LOCALE).map(async (locale) => {
            const allPosts = await getPosts(undefined, locale)
            
            return categories.flatMap((category: string) => {
                const slugNameCategory = getCategorySlug(category)
                const filteredPosts = allPosts.filter(
                    (post) => getCategorySlug(post.data.category) === slugNameCategory
                )

                return paginate(filteredPosts, {
                    params: {
                        lang: locale,
                        category: slugNameCategory
                    },
                    pageSize: siteConfig.paginationSize
                })
            })
        })
    )).flat()
}

const params = Astro.params
const { page } = Astro.props
const locale = params.lang || DEFAULT_LOCALE

const categoryTitle = getCategoryTitleFromSlug(params.category!.toLowerCase(), locale)
const indexPage = await getIndexPageByCategory(params.category!.toLowerCase(), locale)
const posts = page.data
---

<BaseLayout title={params.category}>
	<TitlePage title={categoryTitle} />
	<ListCategories activeCategory={params.category} />
	{
		indexPage &&
			[indexPage].map(async (post) => {
				const { Content } = await post.render()
				return <Content components={{ ...components, pre: Code, SButton }} />
			})
	}
	<ListPosts posts={posts} />
	<Pagination page={page} />
</BaseLayout>
